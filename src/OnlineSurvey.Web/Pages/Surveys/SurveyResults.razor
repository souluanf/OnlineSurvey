@page "/surveys/{SurveyId:guid}/results"
@using System.Globalization
@using OnlineSurvey.Web.Models
@using OnlineSurvey.Web.Services
@inject ISurveyApiService SurveyService

<PageTitle>Resultados da Pesquisa</PageTitle>

@if (_loading)
{
    <p><em>Carregando resultados...</em></p>
}
else if (_results is null)
{
    <div class="alert alert-danger">Resultados não encontrados.</div>
}
else
{
    <h1>Resultados: @_results.SurveyTitle</h1>
    <p class="lead">Total de respostas: <strong>@_results.TotalResponses</strong></p>

    @foreach (var question in _results.Questions)
    {
        <div class="card mb-4">
            <div class="card-header">
                <strong>@question.QuestionText</strong>
            </div>
            <div class="card-body">
                @foreach (var option in question.Options)
                {
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>@option.OptionText</span>
                            <span>@option.Count votos (@option.Percentage.ToString("F2")%)</span>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar @GetProgressBarColor(option.Percentage)"
                                 role="progressbar"
                                 style="width: @(option.Percentage.ToString(CultureInfo.InvariantCulture))%"
                                 aria-valuenow="@(option.Percentage.ToString(CultureInfo.InvariantCulture))"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <a href="/surveys" class="btn btn-outline-primary">Voltar às Pesquisas</a>
}

@code {
    [Parameter]
    public Guid SurveyId { get; set; }

    private SurveyResultResponse? _results;
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        _results = await SurveyService.GetSurveyResultsAsync(SurveyId);
        _loading = false;
    }

    private static string GetProgressBarColor(double percentage) => percentage switch
    {
        > 50 => "bg-success",
        > 25 => "bg-info",
        > 10 => "bg-warning",
        _ => "bg-secondary"
    };
}